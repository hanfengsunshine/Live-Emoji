/*!
* d3-node-editor v0.6.6
* (c) 2017 Vitaliy Stoliarov
* Released under the MIT License.
*/
!function(t){"use strict";function e(t,e,n,o){var i=e&&e.prototype instanceof r?e:r,u=Object.create(i.prototype),a=new h(o||[]);return u._invoke=s(t,n,a),u}function n(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}function r(){}function o(){}function i(){}function u(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function a(t){function e(r,o,i,u){var a=n(t[r],t,o);if("throw"!==a.type){var s=a.arg,c=s.value;return c&&"object"==typeof c&&y.call(c,"__await")?Promise.resolve(c.__await).then(function(t){e("next",t,i,u)},function(t){e("throw",t,i,u)}):Promise.resolve(c).then(function(t){s.value=t,i(s)},u)}u(a.arg)}function r(t,n){function r(){return new Promise(function(r,o){e(t,n,r,o)})}return o=o?o.then(r,r):r()}var o;this._invoke=r}function s(t,e,r){var o=O;return function(i,u){if(o===N)throw new Error("Generator is already running");if(o===T){if("throw"===i)throw u;return p()}for(r.method=i,r.arg=u;;){var a=r.delegate;if(a){var s=c(a,r);if(s){if(s===G)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===O)throw o=T,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=N;var l=n(t,e,r);if("normal"===l.type){if(o=r.done?T:j,l.arg===G)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=T,r.method="throw",r.arg=l.arg)}}}function c(t,e){var r=t.iterator[e.method];if(r===v){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=v,c(t,e),"throw"===e.method))return G;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return G}var o=n(r,t.iterator,e.arg);if("throw"===o.type)return e.method="throw",e.arg=o.arg,e.delegate=null,G;var i=o.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=v),e.delegate=null,G):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,G)}function l(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function f(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function h(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(l,this),this.reset(!0)}function d(t){if(t){var e=t[w];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,r=function e(){for(;++n<t.length;)if(y.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=v,e.done=!0,e};return r.next=r}}return{next:p}}function p(){return{value:v,done:!0}}var v,m=Object.prototype,y=m.hasOwnProperty,g="function"==typeof Symbol?Symbol:{},w=g.iterator||"@@iterator",b=g.asyncIterator||"@@asyncIterator",x=g.toStringTag||"@@toStringTag",k="object"==typeof module,E=t.regeneratorRuntime;if(E)return void(k&&(module.exports=E));E=t.regeneratorRuntime=k?module.exports:{},E.wrap=e;var O="suspendedStart",j="suspendedYield",N="executing",T="completed",G={},A={};A[w]=function(){return this};var V=Object.getPrototypeOf,C=V&&V(V(d([])));C&&C!==m&&y.call(C,w)&&(A=C);var L=i.prototype=r.prototype=Object.create(A);o.prototype=L.constructor=i,i.constructor=o,i[x]=o.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===o||"GeneratorFunction"===(e.displayName||e.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,i):(t.__proto__=i,x in t||(t[x]="GeneratorFunction")),t.prototype=Object.create(L),t},E.awrap=function(t){return{__await:t}},u(a.prototype),a.prototype[b]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,o){var i=new a(e(t,n,r,o));return E.isGeneratorFunction(n)?i:i.next().then(function(t){return t.done?t.value:i.next()})},u(L),L[x]="Generator",L[w]=function(){return this},L.toString=function(){return"[object Generator]"},E.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},E.values=d,h.prototype={constructor:h,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=v,this.done=!1,this.delegate=null,this.method="next",this.arg=v,this.tryEntries.forEach(f),!t)for(var e in this)"t"===e.charAt(0)&&y.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=v)},stop:function(){this.done=!0;var t=this.tryEntries[0],e=t.completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){function e(e,r){return i.type="throw",i.arg=t,n.next=e,r&&(n.method="next",n.arg=v),!!r}if(this.done)throw t;for(var n=this,r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],i=o.completion;if("root"===o.tryLoc)return e("end");if(o.tryLoc<=this.prev){var u=y.call(o,"catchLoc"),a=y.call(o,"finallyLoc");if(u&&a){if(this.prev<o.catchLoc)return e(o.catchLoc,!0);if(this.prev<o.finallyLoc)return e(o.finallyLoc)}else if(u){if(this.prev<o.catchLoc)return e(o.catchLoc,!0)}else{if(!a)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return e(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&y.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=t,i.arg=e,o?(this.method="next",this.next=o.finallyLoc,G):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),G},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),f(n),G}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;f(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:d(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=v),G}}}(function(){return this}()||Function("return this")()),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.D3NE={})}(this,function(t){"use strict";function e(t,n){if(void 0===n&&(n=0),n+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(n>4)return"[...]";var r=e(t[0],n);return t.every(function(t){return e(t,n)===r})?r.trim()+"[]":"["+t.slice(0,15).map(function(t){return e(t,n)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var o=Object.keys(t);if(!o.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(n>4)return"{...}";var i="  ".repeat(n-1),u=o.slice(0,15).map(function(r){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(r)?r:JSON.stringify(r))+": "+e(t[r],n)+";"}).join("\n  "+i);return o.length>=15&&(u+="\n  "+i+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+i+u+"\n"+i+"}":"{\n  "+i+u+"\n"+i+"}"}function n(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var r=n(t[0],e);return t.every(function(t){return n(t,e)===r})?r.trim()+"[]":"["+t.slice(0,15).map(function(t){return n(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var o=Object.keys(t);if(!o.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var i="  ".repeat(e-1),u=o.slice(0,15).map(function(r){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(r)?r:JSON.stringify(r))+": "+n(t[r],e)+";"}).join("\n  "+i);return o.length>=15&&(u+="\n  "+i+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+i+u+"\n"+i+"}":"{\n  "+i+u+"\n"+i+"}"}function r(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=r(t[0],e);return t.every(function(t){return r(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return r(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var o=Object.keys(t);if(!o.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var i="  ".repeat(e-1),u=o.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+r(t[n],e)+";"}).join("\n  "+i);return o.length>=15&&(u+="\n  "+i+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+i+u+"\n"+i+"}":"{\n  "+i+u+"\n"+i+"}"}function o(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=o(t[0],e);return t.every(function(t){return o(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return o(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var i="  ".repeat(e-1),u=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+o(t[n],e)+";"}).join("\n  "+i);return r.length>=15&&(u+="\n  "+i+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+i+u+"\n"+i+"}":"{\n  "+i+u+"\n"+i+"}"}function i(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=i(t[0],e);return t.every(function(t){return i(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return i(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),u=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+i(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(u+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+u+"\n"+o+"}":"{\n  "+o+u+"\n"+o+"}"}function u(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=u(t[0],e);return t.every(function(t){return u(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return u(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+u(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}function a(t,e,n,r){var o=this,i=r.changeDetector.locals.group;i.el=e,r.watch("node.style",function(){Object.assign(e.style,i.style)},{deep:!0}),d3.select(e).call(d3.drag().on("start",function(){d3.event.sourceEvent.shiftKey||o.editor.selectGroup(i,d3.event.sourceEvent.ctrlKey)}).on("drag",function(){if(!o.editor.readOnly){var t=o.transform.k,e=d3.event.dx/t,n=d3.event.dy/t;o.editor.selected.each(function(t){t.position[0]+=e,t.position[1]+=n}),o.editor.selected.eachGroup(function(t){for(var r in t.nodes){var i=t.nodes[r];o.editor.selected.contains(i)||(i.position[0]+=e,i.position[1]+=n)}}),o.update()}}).on("end",function(){o.editor.eventListener.trigger("change")}));var u={"Remove group":function(){o.editor.removeGroup(i)}},a=function(t){t.call(o),o.contextMenu.hide()};d3.select(e).on("contextmenu",function(){if(!o.editor.readOnly){var t=d3.event.clientX,e=d3.event.clientY;o.editor.selectGroup(i),o.contextMenu.show(t,e,u,!1,a),d3.event.preventDefault()}})}function s(t,e,n,r){var o=this,i=r.changeDetector.locals.group,u=null;d3.select(e).call(d3.drag().on("start",function(){u=d3.mouse(o.container.node()),o.editor.selectGroup(i)}).on("drag",function(){if(!o.editor.readOnly){var t=d3.zoomTransform(o.container),e=d3.mouse(o.container.node()),r=(e[0]-u[0])/t.k,a=(e[1]-u[1])/t.k,s=Math.max(0,i.width-i.minWidth),c=Math.max(0,i.height-i.minHeight);0!==s&&(u[0]=e[0]),0!==c&&(u[1]=e[1]),n.match("l")?(i.position[0]+=Math.min(s,r),i.setWidth(i.width-r)):n.match("r")&&i.setWidth(i.width+r),n.match("t")?(i.position[1]+=Math.min(c,a),i.setHeight(i.height-a)):n.match("b")&&i.setHeight(i.height+a),o.update()}}).on("end",function(){o.editor.nodes.forEach(function(t){i.isCoverNode(t)?i.addNode(t):i.removeNode(t)}),o.editor.eventListener.trigger("change"),o.update()}))}function c(t,e,n,r){var o=r.changeDetector.locals.group;d3.select(e).on("click",function(){var t=prompt("Please enter title of the group",o.title);null!==t&&t.length>0&&(o.title=t),r.scan()})}function l(t,e,n,r){var o=this,i=r.changeDetector.locals.input;i.el=e,d3.select(e).on("mousedown",function(){if(!o.editor.readOnly){if(d3.event.preventDefault(),null===o.pickedOutput)return i.hasConnection()&&(o.pickedOutput=i.connections[0].output,o.editor.removeConnection(i.connections[0])),void o.update();if(!i.multipleConnections&&i.hasConnection()&&o.editor.removeConnection(i.connections[0]),!o.pickedOutput.multipleConnections&&o.pickedOutput.hasConnection()&&o.editor.removeConnection(o.pickedOutput.connections[0]),o.pickedOutput.connectedTo(i)){var t=i.connections.find(function(t){return t.output===o.pickedOutput});o.editor.removeConnection(t)}o.editor.connect(o.pickedOutput,i),o.pickedOutput=null,o.update()}})}function f(t,e,n,r){var o=this,i=r.changeDetector.locals.output;i.el=e,d3.select(e).on("mousedown",function(){o.editor.readOnly||(o.pickedOutput=i)})}function h(t,e,n,r){var o=r.changeDetector.locals.path,i=o.connection;if(i){i.el=e,r.watch("path.connection.style",function(){Object.assign(e.style,i.style)},{deep:!0});var u=o.connection.input,a=o.connection.output;e.dataset.inputNode=u.node.id,e.dataset.inputIndex=u.node.inputs.indexOf(u),e.dataset.outputNode=a.node.id,e.dataset.outputIndex=a.node.outputs.indexOf(a),e.className.baseVal+=" output-"+a.socket.id.toLowerCase().replace(" ","-"),e.className.baseVal+=" input-"+u.socket.id.toLowerCase().replace(" ","-")}}function d(t,e,n,r){var o=r.changeDetector.locals,i=o.input?o.input.control:o.control;e.innerHTML=i.html,i.handler(e.children[0],i)}function p(t,e,n,r){var o=this,i=r.changeDetector.locals,u=i.subitem||i.item,a=u.constructor===Object;d3.select(e).on("click",function(){a||o.onClick(u),d3.event.stopPropagation()}).classed("have-subitems",a)}function v(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=v(t[0],e);return t.every(function(t){return v(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return v(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+v(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}function m(t,e,n,r){var o=this,i=r.changeDetector.locals.node;i.el=e,r.watch("node.style",function(){Object.assign(e.style,i.style)},{deep:!0}),d3.select(e).call(d3.drag().on("start",function(){d3.select(e).raise(),d3.event.sourceEvent.shiftKey||o.editor.selectNode(i,d3.event.sourceEvent.ctrlKey)}).on("drag",function(){if(!o.editor.readOnly){var t=o.transform.k,e=d3.event.dx/t,n=d3.event.dy/t;o.editor.selected.each(function(t){t.position[0]+=e,t.position[1]+=n}),o.editor.selected.eachGroup(function(t){for(var r in t.nodes){var i=t.nodes[r];o.editor.selected.contains(i)||(i.position[0]+=e,i.position[1]+=n)}}),o.update()}}).on("end",function(){o.editor.groups.forEach(function(t){o.editor.selected.eachNode(function(e){var n=t.containNode(e),r=t.isCoverNode(e);n&&!r?t.removeNode(e):!n&&r&&t.addNode(e)})}),o.editor.eventListener.trigger("change"),o.update()})),window.addEventListener("load",function(){i.width=e.offsetWidth,i.height=e.offsetHeight});var u={"Remove node":function(){o.editor.removeNode(i)},"Add to group":function(){var t=new W("Group",{nodes:[i]});o.editor.addGroup(t)}},a=function(t){t.call(o),o.contextMenu.hide()};d3.select(e).on("contextmenu",function(){if(!o.editor.readOnly){var t=d3.event.clientX,e=d3.event.clientY;o.editor.selectNode(i),o.contextMenu.show(t,e,u,!1,a),d3.event.preventDefault()}})}function y(t,e){e.directives.al.node=m.bind(t),e.directives.al.group=a.bind(t),e.directives.al.groupHandler=s.bind(t),e.directives.al.groupTitle=c.bind(t),e.directives.al.pickInput=l.bind(t),e.directives.al.pickOutput=f.bind(t),e.directives.al.control=d.bind(t),e.directives.al.connection=h.bind(t)}function g(t,e){e.directives.al.item=p.bind(t)}function w(t){var e="";try{var n={};e+='<div class="context-menu" :style.left="contextMenu.x+&quot;px&quot;" :style.top="contextMenu.y+&quot;px&quot;" @mouseleave="contextMenu.hide()" al-if="contextMenu.visible">',e+='<div class="search item" al-if="contextMenu.searchBar">',e+='<input al-value="filter"></div>',e+='<div class="item" al-repeat="(name,item) in contextMenu.searchItems(filter)" al-item>',e+="{{name}}",e+='<div class="subitems" al-if="contextMenu.haveSubitems(item)">',e+='<div class="item" al-repeat="(name,subitem) in item" al-item>',e+="{{name}}</div></div></div></div>"}catch(t){pug.rethrow(t,void 0,void 0,n[void 0])}return e}function b(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=b(t[0],e);return t.every(function(t){return b(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return b(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+b(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}function x(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=x(t[0],e);return t.every(function(t){return x(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return x(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+x(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}function k(t){var e="";try{var n={};e+="\x3c!-- Groups--\x3e",e+='<div class="group" al-repeat="group in editor.groups" :style.transform="&quot;translate(&quot;+group.position[0]+&quot;px,&quot;+group.position[1]+&quot;px)&quot;" :style.width="group.width+&quot;px&quot;" :style.height="group.height+&quot;px&quot;" al-group :class.selected="editor.selected.contains(group)">',e+='<div class="group-title" al-group-title>',e+="{{group.title}}</div>",e+='<div class="group-handler right bottom" al-group-handler="rb"></div>',e+='<div class="group-handler left top" al-group-handler="lt"></div>',e+='<div class="group-handler left bottom" al-group-handler="lb"></div>',e+='<div class="group-handler right top" al-group-handler="rt"></div></div>',e+="\x3c!-- Connections--\x3e",e+='<svg class="connections">',e+='<path class="connection" al-repeat="path in editor.paths" :d="path.d" al-connection :class.selected="path.selected"></path></svg>',e+="\x3c!-- Nodes--\x3e",e+="<div class=\"node {{editor.selected.contains(node)?'selected':''}} {{node.title.toLowerCase().replace(' ','-')}}\" al-repeat=\"node in editor.nodes\" :style.transform=\"&quot;translate(&quot;+node.position[0]+&quot;px,&quot;+node.position[1]+&quot;px)&quot;\" al-node :data-id=\"node.id\">",e+='<div al-html="editor.view.getTemplate(node)"></div></div>'}catch(t){pug.rethrow(t,void 0,void 0,n[void 0])}return e}function E(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=E(t[0],e);return t.every(function(t){return E(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return E(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+E(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}function O(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=O(t[0],e);return t.every(function(t){return O(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return O(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+O(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}function j(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=j(t[0],e);return t.every(function(t){return j(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return j(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+j(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}function N(t,e){if(void 0===e&&(e=0),e+=1,null===t)return"null";if(void 0===t)return"void";if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return void 0===t?"undefined":T(t);if(Array.isArray(t)){if(t.length>0){if(e>4)return"[...]";var n=N(t[0],e);return t.every(function(t){return N(t,e)===n})?n.trim()+"[]":"["+t.slice(0,15).map(function(t){return N(t,e)}).join(", ")+(t.length>=15?", ...":"")+"]"}return"Array"}var r=Object.keys(t);if(!r.length)return t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name:"Object";if(e>4)return"{...}";var o="  ".repeat(e-1),i=r.slice(0,15).map(function(n){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(n)?n:JSON.stringify(n))+": "+N(t[n],e)+";"}).join("\n  "+o);return r.length>=15&&(i+="\n  "+o+"..."),t.constructor&&t.constructor.name&&"Object"!==t.constructor.name?t.constructor.name+" {\n  "+o+i+"\n"+o+"}":"{\n  "+o+i+"\n"+o+"}"}var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},G=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},A=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),V=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},C=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},L=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},_=function(){function t(e,n,r){G(this,t);var o=t.extractNodes(e,n),i=t.extractNodes(e,r);this.inputs=[],this.outputs=[],this.keys={input:o.map(function(t){return t.data.name}),output:i.map(function(t){return t.data.name})}}return A(t,[{key:"read",value:function(t){var e=this;this.keys.input.forEach(function(n,r){e.inputs[n]=t[r]})}},{key:"write",value:function(t){var e=this;this.keys.output.forEach(function(n,r){t[r]=e.outputs[n]})}}],[{key:"extractNodes",value:function(t,e){return Object.keys(t.nodes).filter(function(n){return e.includes(t.nodes[n].title)}).map(function(e){return t.nodes[e]}).sort(function(t,e){return t.position[1]>e.position[1]})}}]),t}(),S=function(){function t(e,n){G(this,t),this.engine=null,this.titlesInput=e,this.titlesOutput=n}return A(t,[{key:"getInputs",value:function(t){return _.extractNodes(t,this.titlesInput).map(function(t){return{title:t.title,name:t.data.name}})}},{key:"getOutputs",value:function(t){return _.extractNodes(t,this.titlesOutput).map(function(t){return{title:t.title,name:t.data.name}})}},{key:"workerModule",value:function(t,e,n){var r,o,i;return regeneratorRuntime.async(function(u){for(;;)switch(u.prev=u.next){case 0:return r=t.data.module.data,o=new _(r,this.titlesInput,this.titlesOutput),i=this.engine.clone(),o.read(e),u.next=6,regeneratorRuntime.awrap(i.process(r,null,o));case 6:o.write(n);case 7:case"end":return u.stop()}},null,this)}},{key:"workerInputs",value:function(t,e,n,r){r&&(n[0]=r.inputs[t.data.name][0])}},{key:"workerOutputs",value:function(t,e,n,r){r&&(r.outputs[t.data.name]=e[0][0])}},{key:"setEngine",value:function(t){this.engine=t}}]),t}(),M=function(){function t(e){if(G(this,t),this.constructor===t)throw new TypeError("Cannot construct Block instances");this.id=t.incrementId(e),this.position=[0,0],this.width=0,this.height=0,this.style={}}return A(t,null,[{key:"incrementId",value:function(t){return t.latestId?t.latestId++:t.latestId=1,t.latestId}}]),t}(),I=function(){function t(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(G(this,t),"string"!=typeof n)throw new TypeError('Value of argument "html" violates contract.\n\nExpected:\nstring\n\nGot:\n'+e(n));this.html=n,this.parent=null,this.handler=r}return A(t,[{key:"getNode",value:function(){if(null===this.parent)throw new Error("Control isn't added to Node/Input");return this.parent instanceof Z?this.parent:this.parent.node}},{key:"getData",value:function(t){return this.getNode().data[t]}},{key:"putData",value:function(t,e){this.getNode().data[t]=e}}]),t}(),R=function(){function t(e,n){G(this,t),this.output=e,this.input=n,this.style={},this.input.addConnection(this)}return A(t,[{key:"remove",value:function(){this.input.removeConnection(this),this.output.removeConnection(this)}}]),t}(),P=function(){function t(e,r,o){if(G(this,t),"string"!=typeof e)throw new TypeError('Value of argument "id" violates contract.\n\nExpected:\nstring\n\nGot:\n'+n(e));if("string"!=typeof r)throw new TypeError('Value of argument "name" violates contract.\n\nExpected:\nstring\n\nGot:\n'+n(r));if("string"!=typeof o)throw new TypeError('Value of argument "hint" violates contract.\n\nExpected:\nstring\n\nGot:\n'+n(o));this.id=e,this.name=r,this.hint=o,this.compatible=[]}return A(t,[{key:"combineWith",value:function(e){if(!(e instanceof t))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+n(e));this.compatible.push(e)}},{key:"compatibleWith",value:function(e){if(!(e instanceof t))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+n(e));return this===e||this.compatible.includes(e)}}]),t}(),$=function(){function t(e,n,r){G(this,t),this.node=null,this.multipleConnections=r,this.connections=[],this.title=e,this.socket=n}return A(t,[{key:"removeConnection",value:function(t){if(!(t instanceof R))throw new TypeError('Value of argument "connection" violates contract.\n\nExpected:\nConnection\n\nGot:\n'+r(t));this.connections.splice(this.connections.indexOf(t),1)}}]),t}(),D=function(t){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(G(this,e),"string"!=typeof t)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+o(t));if(!(n instanceof P))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+o(n));if("boolean"!=typeof r)throw new TypeError('Value of argument "multiConns" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+o(r));var i=C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r));return i.control=null,i}return V(e,t),A(e,[{key:"hasConnection",value:function(){return this.connections.length>0}},{key:"addConnection",value:function(t){if(!(t instanceof R))throw new TypeError('Value of argument "connection" violates contract.\n\nExpected:\nConnection\n\nGot:\n'+o(t));if(!this.multipleConnections&&this.hasConnection())throw new Error("Multiple connections not allowed");this.connections.push(t)}},{key:"addControl",value:function(t){if(!(t instanceof I))throw new TypeError('Value of argument "control" violates contract.\n\nExpected:\nControl\n\nGot:\n'+o(t))
;this.control=t,t.parent=this}},{key:"showControl",value:function(){return!this.hasConnection()&&null!==this.control}},{key:"toJSON",value:function(){return{connections:this.connections.map(function(t){return{node:t.output.node.id,output:t.output.node.outputs.indexOf(t.output)}})}}}]),e}($),J=function(t){function e(t,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(G(this,e),"string"!=typeof t)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+i(t));if(!(n instanceof P))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+i(n));if("boolean"!=typeof r)throw new TypeError('Value of argument "multiConns" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+i(r));return C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r))}return V(e,t),A(e,[{key:"hasConnection",value:function(){return this.connections.length>0}},{key:"connectTo",value:function(t){if(!(t instanceof D))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\nInput\n\nGot:\n'+i(t));if(!this.socket.compatibleWith(t.socket))throw new Error("Sockets not compatible");if(!t.multipleConnections&&t.hasConnection())throw new Error("Input already has one connection");if(!this.multipleConnections&&this.hasConnection())throw new Error("Output already has one connection");var e=new R(this,t);return this.connections.push(e),e}},{key:"connectedTo",value:function(t){if(!(t instanceof D))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\nInput\n\nGot:\n'+i(t));return this.connections.some(function(e){return e.input===t})}},{key:"toJSON",value:function(){return{connections:this.connections.map(function(t){return{node:t.input.node.id,input:t.input.node.inputs.indexOf(t.input)}})}}}]),e}($),Z=function(t){function e(t){if(G(this,e),"string"!=typeof t)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+u(t));var n=C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,e));n.group=null,n.inputs=[],n.outputs=[],n.controls=[],n.data={},n.title=t;var r=[180,100];return n.width=r[0],n.height=r[1],n}return V(e,t),A(e,[{key:"addControl",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!(t instanceof I))throw new TypeError('Value of argument "control" violates contract.\n\nExpected:\nControl\n\nGot:\n'+u(t));if(!(null==e||"number"==typeof e&&!isNaN(e)&&e>=0&&e<=255&&e===Math.floor(e)))throw new TypeError('Value of argument "index" violates contract.\n\nExpected:\n?uint8\n\nGot:\n'+u(e));return t.parent=this,null!==e?this.controls.splice(e,0,t):this.controls.push(t),this}},{key:"addInput",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!(t instanceof D))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\nInput\n\nGot:\n'+u(t));if(!(null==e||"number"==typeof e&&!isNaN(e)&&e>=0&&e<=255&&e===Math.floor(e)))throw new TypeError('Value of argument "index" violates contract.\n\nExpected:\n?uint8\n\nGot:\n'+u(e));if(null!==t.node)throw new Error("Input has already been added to the node");return t.node=this,null!==e?this.inputs.splice(e,0,t):this.inputs.push(t),this}},{key:"addOutput",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!(t instanceof J))throw new TypeError('Value of argument "output" violates contract.\n\nExpected:\nOutput\n\nGot:\n'+u(t));if(!(null==e||"number"==typeof e&&!isNaN(e)&&e>=0&&e<=255&&e===Math.floor(e)))throw new TypeError('Value of argument "index" violates contract.\n\nExpected:\n?uint8\n\nGot:\n'+u(e));if(null!==t.node)throw new Error("Output has already been added to the node");return t.node=this,null!==e?this.outputs.splice(e,0,t):this.outputs.push(t),this}},{key:"getConnections",value:function(t){var e=[];return"input"!==t&&t||this.inputs.map(function(t){t.connections.forEach(function(t){e.push(t)})}),"output"!==t&&t||this.outputs.forEach(function(t){t.connections.forEach(function(t){e.push(t)})}),e}},{key:"inputsWithVisibleControl",value:function(){return this.inputs.filter(function(t){return t.showControl()})}},{key:"toJSON",value:function(){return{id:this.id,data:this.data,group:this.group?this.group.id:null,inputs:this.inputs.map(function(t){return t.toJSON()}),outputs:this.outputs.map(function(t){return t.toJSON()}),position:this.position,title:this.title}}}],[{key:"fromJSON",value:function(t,n){var r;return regeneratorRuntime.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(t instanceof H){o.next=2;break}throw new TypeError('Value of argument "component" violates contract.\n\nExpected:\nComponent\n\nGot:\n'+u(t));case 2:if(n instanceof Object){o.next=4;break}throw new TypeError('Value of argument "json" violates contract.\n\nExpected:\nObject\n\nGot:\n'+u(n));case 4:return r=t.newNode(),r.id=n.id,r.data=n.data,e.latestId=Math.max(r.id,e.latestId),r.position=n.position,r.title=n.title,o.next=12,regeneratorRuntime.awrap(t.builder(r));case 12:return o.abrupt("return",r);case 13:case"end":return o.stop()}},null,this)}}]),e}(M),B=function(t){var e="";try{var n={};e+='<div class="title">',e+="{{node.title}}</div>",e+="\x3c!-- Outputs--\x3e",e+='<div al-repeat="output in node.outputs" style="text-align: right;">',e+='<div class="output-title">',e+="{{output.title}}</div>",e+="<div class=\"socket output {{output.socket.id.toLowerCase().replace(' ','-')}}\" al-pick-output title=\"{{output.socket.name}}\n{{output.socket.hint}}\"></div></div>",e+="\x3c!-- Controls--\x3e",e+='<div class="control" al-repeat="control in node.controls" style="text-align: center;" :width="control.parent.width - 2 * control.margin" :height="control.height" al-control="control"></div>',e+="\x3c!-- Inputs--\x3e",e+='<div al-repeat="input in node.inputs" style="text-align: left;">',e+="<div class=\"socket input {{input.socket.id.toLowerCase().replace(' ','-')}} {{input.multipleConnections?'multiple':''}}\" al-pick-input title=\"{{input.socket.name}}\n{{input.socket.hint}}\"></div>",e+='<div class="input-title" al-if="!input.showControl()">',e+="{{input.title}}</div>",e+='<div class="input-control" al-if="input.showControl()" al-control="input.control"></div></div>'}catch(t){pug.rethrow(t,void 0,void 0,n[void 0])}return e}(),H=function(){function t(e,n){G(this,t),this.name=e,this.template=n.template||B,this.builder=n.builder,this.worker=n.worker}return A(t,[{key:"newNode",value:function(){return new Z(this.name)}}]),t}(),q=function(){function t(){G(this,t)}return A(t,null,[{key:"nodesBBox",value:function(t){var e=function(t){return Math.min.apply(Math,L(t))},n=function(t){return Math.max.apply(Math,L(t))},r=e(t.map(function(t){return t.position[0]})),o=e(t.map(function(t){return t.position[1]})),i=n(t.map(function(t){return t.position[0]+t.width})),u=n(t.map(function(t){return t.position[1]+t.height}));return{left:r,right:i,top:o,bottom:u,width:Math.abs(r-i),height:Math.abs(o-u),getCenter:function(){return[(r+i)/2,(o+u)/2]}}}},{key:"getConnectionPath",value:function(t,e,n){var r=n.apply(void 0,L(t).concat(L(e))),o=r.points,i=r.curve;switch(i){case"linear":i=d3.curveLinear;break;case"step":i=d3.curveStep;break;case"basis":default:i=d3.curveBasis}return this.pointsToPath(o,i)}},{key:"pointsToPath",value:function(t,e){var n=e(d3.path());n.lineStart();for(var r=0;r<t.length;r++)n.point.apply(n,L(t[r]));return n.lineEnd(),n._context.toString()}},{key:"getOutputPosition",value:function(t){var e=t.node,n=t.el;return[e.position[0]+n.offsetLeft+n.offsetWidth/2,e.position[1]+n.offsetTop+n.offsetHeight/2]}},{key:"getInputPosition",value:function(t){var e=t.node,n=t.el;return[e.position[0]+n.offsetLeft+n.offsetWidth/2,e.position[1]+n.offsetTop+n.offsetHeight/2]}},{key:"isValidData",value:function(t){return"string"==typeof t.id&&this.isValidId(t.id)&&t.nodes instanceof Object&&!(t.nodes instanceof Array)&&(!t.groups||t.groups instanceof Object)}},{key:"isValidId",value:function(t){return/^[\w-]{3,}@[0-9]+\.[0-9]+\.[0-9]+$/.test(t)}},{key:"validate",value:function(t,e){var n="",r=t.split("@"),o=e.id.split("@");return this.isValidData(e)||(n+="Data is not suitable. "),t!==e.id&&(n+="IDs not equal. "),r[0]!==o[0]&&(n+="Names don't match. "),r[1]!==o[1]&&(n+="Versions don't match"),{success:""===n,msg:n}}}]),t}(),W=function(t){function e(t,n){if(G(this,e),"string"!=typeof t)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+v(t));if(!(n instanceof Object))throw new TypeError('Value of argument "params" violates contract.\n\nExpected:\nObject\n\nGot:\n'+v(n));var r=C(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,e));return r.title=t,r.nodes=[],r.setMinSizes(300,250),n.nodes?r.coverNodes(n.nodes):(r.position=n.position,r.width=n.width,r.height=n.height),r}return V(e,t),A(e,[{key:"setMinSizes",value:function(t,e){this.minWidth=t,this.minHeight=e}},{key:"setWidth",value:function(t){if("number"!=typeof t)throw new TypeError('Value of argument "w" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+v(t));return this.width=Math.max(this.minWidth,t)}},{key:"setHeight",value:function(t){if("number"!=typeof t)throw new TypeError('Value of argument "h" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+v(t));return this.height=Math.max(this.minHeight,t)}},{key:"isCoverNode",value:function(t){if(!(t instanceof Z))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+v(t));var e=this.position,n=t.position;return n[0]>e[0]&&n[1]>e[1]&&n[0]+t.width<e[0]+this.width&&n[1]+t.height<e[1]+this.height}},{key:"coverNodes",value:function(t){if(!Array.isArray(t)||!t.every(function(t){return t instanceof Z}))throw new TypeError('Value of argument "nodes" violates contract.\n\nExpected:\nNode[]\n\nGot:\n'+v(t));var e=this,n=q.nodesBBox(t);t.forEach(function(t){null!==t.group&&t.group.removeNode(t.group),e.addNode(t)}),this.position=[n.left-30,n.top-60],this.setWidth(n.right-n.left+60),this.setHeight(n.bottom-n.top+90)}},{key:"containNode",value:function(t){if(!(t instanceof Z))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+v(t));return-1!==this.nodes.indexOf(t)}},{key:"addNode",value:function(t){if(!(t instanceof Z))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+v(t));return!this.containNode(t)&&(null!==t.group&&t.group.removeNode(t),t.group=this,this.nodes.push(t),!0)}},{key:"removeNode",value:function(t){if(!(t instanceof Z))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+v(t));this.containNode(t)&&(this.nodes.splice(this.nodes.indexOf(t),1),t.group=null)}},{key:"remove",value:function(){this.nodes.forEach(function(t){t.group=null})}},{key:"toJSON",value:function(){return{id:this.id,title:this.title,nodes:this.nodes.map(function(t){return t.id}),minWidth:this.minWidth,minHeight:this.minHeight,position:this.position,width:this.width,height:this.height}}}],[{key:"fromJSON",value:function(t){if(!(t instanceof Object))throw new TypeError('Value of argument "json" violates contract.\n\nExpected:\nObject\n\nGot:\n'+v(t));var n=new e(t.title,{position:t.position,width:t.width,height:t.height});return n.id=t.id,e.latestId=Math.max(n.id,e.latestId),n.minWidth=t.minWidth,n.minHeight=t.minHeight,n}}]),e}(M),z=function(){function t(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(G(this,t),!(e instanceof Object))throw new TypeError('Value of argument "items" violates contract.\n\nExpected:\nObject\n\nGot:\n'+b(e));if("boolean"!=typeof n)throw new TypeError('Value of argument "searchBar" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+b(n));this.visible=!1,this.x=0,this.y=0,this.default={items:e,searchBar:n,onClick:function(){throw new TypeError("onClick should be overrided")}},this.bindTemplate(w())}return A(t,[{key:"bindTemplate",value:function(t){this.dom=d3.select("body").append("div"),this.dom.node().setAttribute("tabindex",1),this.dom.html(t),g(this,alight),this.$cd=alight(this.dom.node(),{contextMenu:this})}},{key:"searchItems",value:function(t){var e=this;if(null!=t&&"string"!=typeof t)throw new TypeError('Value of argument "filter" violates contract.\n\nExpected:\n?string\n\nGot:\n'+b(t));var n=new RegExp(t,"i"),r={};return Object.keys(this.items).forEach(function(t){var o=e.items[t];if(o.constructor===Object){var i=Object.keys(o).filter(function(t){return n.test(t)});i.length>0&&(r[t]={},i.forEach(function(e){r[t][e]=o[e]}))}else n.test(t)&&(r[t]=o)}),r}},{key:"haveSubitems",value:function(t){return t.constructor===Object}},{key:"isVisible",value:function(){return this.visible}},{key:"show",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if("number"!=typeof t)throw new TypeError('Value of argument "x" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+b(t));if("number"!=typeof e)throw new TypeError('Value of argument "y" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+b(e));if(!(null==n||n instanceof Object))throw new TypeError('Value of argument "items" violates contract.\n\nExpected:\n?Object\n\nGot:\n'+b(n));if(null!=r&&"boolean"!=typeof r)throw new TypeError('Value of argument "searchBar" violates contract.\n\nExpected:\n?boolean\n\nGot:\n'+b(r));this.visible=!0,this.items=n||this.default.items,this.searchBar=r||this.default.searchBar,this.onClick=o||this.default.onClick,this.x=t,this.y=e,this.$cd.scan()}},{key:"hide",value:function(){this.visible=!1,this.$cd.scan()}}]),t}(),K=function(t){return parseInt(t)},F=function(t,e){return t.every(function(t,n){return t===e[n]})},Y=function(t,e){return JSON.stringify(t)===JSON.stringify(e)},X=function(t,e,n){return t.node===e.node&&t[n]===e[n]},U=function(t,e){return{removed:t.filter(function(t){return!e.some(function(e){return X(t,e,"input")})}),added:e.filter(function(e){return!t.some(function(t){return X(t,e,"input")})})}},Q=function(){function t(e,n){G(this,t),this.a=e,this.b=n}return A(t,[{key:"compare",value:function(){var t=this.a,e=this.b,n=Object.keys(t.nodes),r=Object.keys(e.nodes),o=n.filter(function(t){return!r.includes(t)}).map(K),i=r.filter(function(t){return!n.includes(t)}).map(K),u=n.filter(function(t){return r.includes(t)}).map(K);return{removed:o,added:i,moved:u.filter(function(n){var r=t.nodes[n].position,o=e.nodes[n].position;return!F(r,o)}),datachanged:u.filter(function(n){var r=t.nodes[n].data,o=e.nodes[n].data;return!Y(r,o)}),connects:u.reduce(function(n,r){var o=t.nodes[r].outputs,i=e.nodes[r].outputs,u=o.map(function(t,e){return Object.assign({output:e},U(t.connections,i[e].connections))}).filter(function(t){return 0!==t.added.length||0!==t.removed.length});return[].concat(L(n),L(u.map(function(t){return t.node=r,t})))},[])}}}]),t}(),tt={AVALIABLE:0,PROCESSED:1,ABORT:2},et=function(){function t(e,n){if(G(this,t),"string"!=typeof e)throw new TypeError('Value of argument "id" violates contract.\n\nExpected:\nstring\n\nGot:\n'+x(e));if(!Array.isArray(n)||!n.every(function(t){return t instanceof H}))throw new TypeError('Value of argument "components" violates contract.\n\nExpected:\nComponent[]\n\nGot:\n'+x(n));if(!q.isValidId(e))throw new Error("ID should be valid to name@0.1.0 format");this.id=e,this.components=n,this.args=[],this.data=null,this.state=tt.AVALIABLE,this.onAbort=function(){}}return A(t,[{key:"clone",value:function(){return new t(this.id,this.components)}},{key:"processStart",value:function(){return this.state===tt.AVALIABLE?(this.state=tt.PROCESSED,!0):this.state!==tt.ABORT&&(console.warn("The process is busy and has not been restarted. Use abort() to force it to complete"),!1)}},{key:"processDone",value:function(){var t=this.state!==tt.ABORT;return this.state=tt.AVALIABLE,t||(this.onAbort(),this.onAbort=function(){}),t}},{key:"abort",value:function(){var t=this;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){t.state===tt.PROCESSED?(t.state=tt.ABORT,t.onAbort=e):t.state===tt.ABORT?(t.onAbort(),t.onAbort=e):e()}));case 1:case"end":return e.stop()}},null,this)}},{key:"lock",value:function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){t.unlockPool=t.unlockPool||[],t.busy&&!t.outputData?t.unlockPool.push(e):e(),t.busy=!0}));case 1:case"end":return e.stop()}},null,this)}},{key:"unlock",value:function(t){t.unlockPool.forEach(function(t){return t()}),t.unlockPool=[],t.busy=!1}},{key:"extractInputData",value:function(t){var e=this;return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(Promise.all(t.inputs.map(function(t){var n,r;return regeneratorRuntime.async(function(o){for(;;)switch(o.prev=o.next){case 0:return n=t.connections,o.next=3,regeneratorRuntime.awrap(Promise.all(n.map(function(t){var n;return regeneratorRuntime.async(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,regeneratorRuntime.awrap(e.processNode(e.data.nodes[t.node]));case 2:if(n=r.sent){r.next=7;break}e.abort(),r.next=8;break;case 7:return r.abrupt("return",n[t.output]);case 8:case"end":return r.stop()}},null,e)})));case 3:return r=o.sent,o.abrupt("return",r);case 5:case"end":return o.stop()}},null,e)})));case 2:return n.abrupt("return",n.sent);case 3:case"end":return n.stop()}},null,this)}},{key:"processNode",value:function(t){var e,n,r;return regeneratorRuntime.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(this.state!==tt.ABORT&&t){o.next=2;break}return o.abrupt("return",null);case 2:return o.next=4,regeneratorRuntime.awrap(this.lock(t));case 4:if(t.outputData){o.next=22;break}return o.next=7,regeneratorRuntime.awrap(this.extractInputData(t));case 7:return e=o.sent,t.outputData=t.outputs.map(function(){return null}),n=t.title,r=this.components.find(function(t){return t.name===n}),o.prev=11,o.next=14,regeneratorRuntime.awrap(r.worker.apply(r,[t,e,t.outputData].concat(L(this.args))));case 14:o.next=20;break;case 16:o.prev=16,o.t0=o.catch(11),this.abort(),console.warn(o.t0);case 20:if(t.outputData.length===t.outputs.length){o.next=22;break}throw new Error("Output data does not correspond to number of outputs");case 22:return this.unlock(t),o.abrupt("return",t.outputData);case 24:case"end":return o.stop()}},null,this,[[11,16]])}},{key:"forwardProcess",value:function(t){var e=this;return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:if(this.state!==tt.ABORT){n.next=2;break}return n.abrupt("return",null);case 2:return n.next=4,regeneratorRuntime.awrap(Promise.all(t.outputs.map(function(t){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(Promise.all(t.connections.map(function(t){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(e.processNode(e.data.nodes[t.node]));case 2:return n.next=4,regeneratorRuntime.awrap(e.forwardProcess(e.data.nodes[t.node]));case 4:case"end":return n.stop()}},null,e)})));case 2:return n.abrupt("return",n.sent);case 3:case"end":return n.stop()}},null,e)})));case 4:return n.abrupt("return",n.sent);case 5:case"end":return n.stop()}},null,this)}},{key:"copy",value:function(t){return t=Object.assign({},t),t.nodes=Object.assign({},t.nodes),Object.keys(t.nodes).forEach(function(e){t.nodes[e]=Object.assign({},t.nodes[e])}),t}},{key:"process",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length,r=Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];var i,u,a,s;return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:if(t instanceof Object){n.next=2;break}throw new TypeError('Value of argument "data" violates contract.\n\nExpected:\nObject\n\nGot:\n'+x(t));case 2:if(null==e||"number"==typeof e){n.next=4;break}throw new TypeError('Value of argument "startId" violates contract.\n\nExpected:\n?number\n\nGot:\n'+x(e));case 4:if(this.processStart()){n.next=6;break}return n.abrupt("return");case 6:if(i=q.validate(this.id,t),i.success){n.next=9;break}throw new Error(i.msg);case 9:if(this.data=this.copy(t),this.args=r,!e){n.next=19;break}if(u=this.data.nodes[e]){n.next=15;break}throw new Error("Node with such id not found");case 15:return n.next=17,regeneratorRuntime.awrap(this.processNode(u));case 17:return n.next=19,regeneratorRuntime.awrap(this.forwardProcess(u));case 19:n.t0=regeneratorRuntime.keys(this.data.nodes);case 20:if((n.t1=n.t0()).done){n.next=30;break}if(a=n.t1.value,void 0!==this.data.nodes[a].outputData){n.next=28;break}return s=this.data.nodes[a],n.next=26,regeneratorRuntime.awrap(this.processNode(s));case 26:return n.next=28,regeneratorRuntime.awrap(this.forwardProcess(s));case 28:n.next=20;break;case 30:return n.abrupt("return",this.processDone()?"success":"aborted");case 31:case"end":return n.stop()}},null,this)}}]),t}(),nt=function(){function t(e,n,r){var o=this;if(G(this,t),!(e instanceof at))throw new TypeError('Value of argument "editor" violates contract.\n\nExpected:\nNodeEditor\n\nGot:\n'+E(e));if(!(n instanceof HTMLElement))throw new TypeError('Value of argument "container" violates contract.\n\nExpected:\nHTMLElement\n\nGot:\n'+E(n));if(!(r instanceof z))throw new TypeError('Value of argument "menu" violates contract.\n\nExpected:\nContextMenu\n\nGot:\n'+E(r));this.editor=e,this.pickedOutput=null,this.container=d3.select(n).attr("tabindex",1),this.mouse=[0,0],this.transform=d3.zoomIdentity,this.contextMenu=r,this.container.on("click",function(){o.container.node()===d3.event.target&&o.areaClick()}),this.view=this.container.append("div").style("transform-origin","0 0").style("width",1).style("height",1),this.zoom=d3.zoom().on("zoom",function(){o.transform=d3.event.transform,o.update(),o.editor.eventListener.trigger("transform",o.transform)}),this.container.call(this.zoom),this.setScaleExtent(.1,1);var i=Math.pow(2,12);this.setTranslateExtent(-i,-i,i,i),d3.select(window).on("mousemove.d3ne"+e._id,function(){var t=o.transform.k,e=d3.mouse(o.view.node());o.mouse=[e[0]/t,e[1]/t],o.update()}).on("keydown.d3ne"+e._id,function(t){o.container.node()===document.activeElement&&e.keyDown(t)}).on("resize.d3ne"+e._id,this.resize.bind(this)),this.view.html(k());var u=alight.makeInstance();y(this,u),this.$cd=u(this.view.node(),{editor:e})}return A(t,[{key:"getTemplate",value:function(t){return this.editor.components.find(function(e){return e.name===t.title}).template}},{key:"resize",value:function(){var t=this.container.node().parentElement.clientWidth,e=this.container.node().parentElement.clientHeight;this.container.style("width",t+"px").style("height",e+"px"),this.update()}},{key:"connectionProducer",value:function(t,e,n,r){var o=.3*Math.abs(t-n),i=.1*(r-e);return{points:[[t,e],[t+o,e+i],[n-o,r-i],[n,r]],curve:"basis"}}},{key:"updateConnections",value:function(){var t=this,e=[];if(this.editor.nodes.forEach(function(n){n.getConnections("output").forEach(function(n){var r=n.output,o=n.input;o.el&&e.push({connection:n,d:q.getConnectionPath(q.getOutputPosition(r),q.getInputPosition(o),t.connectionProducer)})})}),null!==this.pickedOutput&&this.pickedOutput.el){var n=this.pickedOutput,r=this.mouse;e.push({selected:!0,d:q.getConnectionPath(q.getOutputPosition(n),r,this.connectionProducer)})}this.editor.paths=e}},{key:"update",value:function(){var t=this.transform;this.view.style("transform","translate("+t.x+"px, "+t.y+"px) scale("+t.k+")"),this.updateConnections(),this.$cd.scan()}},{key:"assignContextMenuHandler",value:function(){var t=this;this.contextMenu.default.onClick=function(e){var n;return regeneratorRuntime.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(!(e instanceof H)){r.next=8;break}return n=e.newNode(),r.next=4,regeneratorRuntime.awrap(e.builder(n));case 4:t.editor.addNode(n,!0),t.editor.selectNode(n),r.next=9;break;case 8:e();case 9:t.contextMenu.hide();case 10:case"end":return r.stop()}},null,t)}}},{key:"areaClick",value:function(){this.editor.readOnly||(null===this.pickedOutput||d3.event.ctrlKey?this.contextMenu.visible?this.contextMenu.hide():(this.assignContextMenuHandler(),this.contextMenu.show(d3.event.pageX,d3.event.pageY)):this.pickedOutput=null,this.update())}},{key:"zoomAt",value:function(t){if(!Array.isArray(t)||!t.every(function(t){return t instanceof Z}))throw new TypeError('Value of argument "nodes" violates contract.\n\nExpected:\nNode[]\n\nGot:\n'+E(t));if(0!==t.length){var e=this.container.node().clientWidth,n=this.container.node().clientHeight,r=q.nodesBBox(t),o=e/r.width,i=n/r.height,u=Math.min(i,o,1),a=r.getCenter(),s=[e/2,n/2];u*=.9,this.translate(s[0]-a[0]*u,s[1]-a[1]*u),this.scale(u)}}},{key:"translate",value:function(t,e){this.transform.x=t,this.transform.y=e,this.update()}},{key:"scale",value:function(t){this.transform.k=t,this.update()}},{key:"setScaleExtent",value:function(t,e){if("number"!=typeof t)throw new TypeError('Value of argument "scaleMin" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+E(t));if("number"!=typeof e)throw new TypeError('Value of argument "scaleMax" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+E(e));this.zoom.scaleExtent([t,e])}},{key:"setTranslateExtent",value:function(t,e,n,r){if("number"!=typeof t)throw new TypeError('Value of argument "left" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+E(t));if("number"!=typeof e)throw new TypeError('Value of argument "top" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+E(e));if("number"!=typeof n)throw new TypeError('Value of argument "right" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+E(n));if("number"!=typeof r)throw new TypeError('Value of argument "bottom" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+E(r));this.zoom.translateExtent([[t,e],[n,r]])}}]),t}(),rt=function(){function t(){G(this,t),this.events={nodecreate:[],groupcreate:[],connectioncreate:[],noderemove:[],groupremove:[],connectionremove:[],nodeselect:[],groupselect:[],error:[],change:[],transform:[]},this.persistent=!0}return A(t,[{key:"on",value:function(t,e){var n=this;if("string"!=typeof t)throw new TypeError('Value of argument "names" violates contract.\n\nExpected:\nstring\n\nGot:\n'+O(t));if("function"!=typeof e)throw new TypeError('Value of argument "handler" violates contract.\n\nExpected:\n() => {}\n\nGot:\n'+O(e));return t.split(" ").forEach(function(t){if(!n.events[t])throw new Error("The event "+t+" does not exist");n.events[t].push(e)}),this}},{key:"trigger",value:function(t,e){var n=this;if("string"!=typeof t)throw new TypeError('Value of argument "name" violates contract.\n\nExpected:\nstring\n\nGot:\n'+O(t));if(!(t in this.events))throw new Error("The event "+t+" cannot be triggered");return this.events[t].reduce(function(t,r){return!1!==r(e,n.persistent)&&t},!0)}}]),t}(),ot=function t(e,n,r){G(this,t),this.exec=function(){e.apply(void 0,L(r))},this.undo=function(){n.apply(void 0,L(r))},this.a=r[0]},it=function(){function t(e){G(this,t),this.editor=e,this.list=[],this._locked=!1,this.position=-1}return A(t,[{key:"add",value:function(t,e,n){this._locked||(this.position++,this.list.splice(this.position),this.list.push(new ot(t,e,n)))}},{key:"undo",value:function(){this.position<0||(this._locked=!0,this.list[this.position--].undo(),this._locked=!1)}},{key:"redo",value:function(){this.position+1>=this.list.length||(this._locked=!0,this.list[++this.position].exec(),this._locked=!1)}}]),t}(),ut=function(){function t(){G(this,t),this.list=[]}return A(t,[{key:"add",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(t instanceof Z||t instanceof W))throw new TypeError('Value of argument "item" violates contract.\n\nExpected:\nNode | Group\n\nGot:\n'+j(t));e?this.contains(t)?this.remove(t):this.list.push(t):this.list=[t]}},{key:"clear",value:function(){var t=this;this.each(function(e){t.remove(e)})}},{key:"remove",value:function(t){this.list.splice(this.list.indexOf(t),1)}},{key:"contains",value:function(t){return-1!==this.list.indexOf(t)}},{key:"each",value:function(t){this.list.forEach(t)}},{key:"eachNode",value:function(t){this.list.filter(function(t){return t instanceof Z}).forEach(t)}},{key:"eachGroup",value:function(t){this.list.filter(function(t){return t instanceof W}).forEach(t)}},{key:"getNodes",value:function(){return this.list.filter(function(t){return t instanceof Z})}},{key:"getGroups",value:function(){return this.list.filter(function(t){return t instanceof W})}}]),t}(),at=function(){function t(e,n,r,o){if(G(this,t),"string"!=typeof e)throw new TypeError('Value of argument "id" violates contract.\n\nExpected:\nstring\n\nGot:\n'+N(e));if(!(n instanceof HTMLElement))throw new TypeError('Value of argument "container" violates contract.\n\nExpected:\nHTMLElement\n\nGot:\n'+N(n));if(!Array.isArray(r)||!r.every(function(t){return t instanceof H}))throw new TypeError('Value of argument "components" violates contract.\n\nExpected:\nComponent[]\n\nGot:\n'+N(r));if(!(o instanceof z))throw new TypeError('Value of argument "menu" violates contract.\n\nExpected:\nContextMenu\n\nGot:\n'+N(o));if(!q.isValidId(e))throw new Error("ID should be valid to name@0.1.0 format");this.id=e,this._id=Math.random().toString(36).substr(2,9),this.components=r,this.view=new nt(this,n,o),this.eventListener=new rt,this.selected=new ut,this.history=new it(this),this.nodes=[],this.groups=[],this.readOnly=!1,this.view.resize()}return A(t,[{key:"addNode",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(t instanceof Z))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+N(t));this.eventListener.trigger("nodecreate",t)&&(e&&(t.position=this.view.mouse),this.nodes.push(t),this.eventListener.trigger("change"),this.history.add(this.addNode.bind(this),this.removeNode.bind(this),[t]))}},{key:"addGroup",value:function(t){if(!(t instanceof W))throw new TypeError('Value of argument "group" violates contract.\n\nExpected:\nGroup\n\nGot:\n'+N(t));this.eventListener.trigger("groupcreate",t)&&(this.groups.push(t),this.eventListener.trigger("change")),this.view.update()}},{key:"removeNode",value:function(t){var e=this;if(!(t instanceof Z))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+N(t));var n=this.nodes.indexOf(t);this.eventListener.trigger("noderemove",t)&&(t.getConnections().forEach(function(t){return e.removeConnection(t)}),this.nodes.splice(n,1),this.eventListener.trigger("change"),this.history.add(this.removeNode.bind(this),this.addNode.bind(this),[t])),this.view.update()}},{key:"removeGroup",value:function(t){if(!(t instanceof W))throw new TypeError('Value of argument "group" violates contract.\n\nExpected:\nGroup\n\nGot:\n'+N(t));this.eventListener.trigger("groupremove",t)&&(t.remove(),this.groups.splice(this.groups.indexOf(t),1),this.eventListener.trigger("change")),this.view.update()}},{key:"connect",value:function(t,e){if(!(t instanceof J||t instanceof R))throw new TypeError('Value of argument "output" violates contract.\n\nExpected:\nOutput | Connection\n\nGot:\n'+N(t));if(!(null==e||e instanceof D))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\n?Input\n\nGot:\n'+N(e));if(t instanceof R&&(e=t.input,t=t.output),this.eventListener.trigger("connectioncreate",{output:t,input:e}))try{var n=t.connectTo(e);this.eventListener.trigger("change"),this.history.add(this.connect.bind(this),this.removeConnection.bind(this),[n])}catch(t){console.warn(t),this.eventListener.trigger("error",t)}this.view.update()}},{key:"removeConnection",value:function(t){if(!(t instanceof R))throw new TypeError('Value of argument "connection" violates contract.\n\nExpected:\nConnection\n\nGot:\n'+N(t))
;this.eventListener.trigger("connectionremove",t)&&(t.remove(),this.eventListener.trigger("change"),this.history.add(this.removeConnection.bind(this),this.connect.bind(this),[t])),this.view.update()}},{key:"selectNode",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(t instanceof Z))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+N(t));if("boolean"!=typeof e)throw new TypeError('Value of argument "accumulate" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+N(e));if(-1===this.nodes.indexOf(t))throw new Error("Node not exist in list");this.eventListener.trigger("nodeselect",t)&&this.selected.add(t,e),this.view.update()}},{key:"selectGroup",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(t instanceof W))throw new TypeError('Value of argument "group" violates contract.\n\nExpected:\nGroup\n\nGot:\n'+N(t));if("boolean"!=typeof e)throw new TypeError('Value of argument "accumulate" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+N(e));if(-1===this.groups.indexOf(t))throw new Error("Group not exist in list");this.eventListener.trigger("groupselect",t)&&this.selected.add(t,e),this.view.update()}},{key:"keyDown",value:function(){if(!this.readOnly)switch(d3.event.keyCode){case 46:this.selected.eachNode(this.removeNode.bind(this)),this.selected.eachGroup(this.removeGroup.bind(this)),this.view.update();break;case 71:var t=this.selected.getNodes();t.length>0&&this.addGroup(new W("Group",{nodes:t}));break;case 90:d3.event.ctrlKey&&d3.event.shiftKey?this.history.redo():d3.event.ctrlKey&&this.history.undo()}}},{key:"clear",value:function(){this.nodes.splice(0,this.nodes.length),this.groups.splice(0,this.groups.length)}},{key:"toJSON",value:function(){var t={},e={};return this.nodes.forEach(function(e){return t[e.id]=e.toJSON()}),this.groups.forEach(function(t){return e[t.id]=t.toJSON()}),{id:this.id,nodes:t,groups:e}}},{key:"fromJSON",value:function(t){var e,n,r=this;return regeneratorRuntime.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(t instanceof Object){o.next=2;break}throw new TypeError('Value of argument "json" violates contract.\n\nExpected:\nObject\n\nGot:\n'+N(t));case 2:if(e=q.validate(this.id,t),e.success){o.next=7;break}return this.eventListener.trigger("error",e.msg),console.warn(e.msg),o.abrupt("return",!1);case 7:return this.eventListener.persistent=!1,this.clear(),n={},o.prev=10,o.next=13,regeneratorRuntime.awrap(Promise.all(Object.keys(t.nodes).map(function(e){var o,i;return regeneratorRuntime.async(function(u){for(;;)switch(u.prev=u.next){case 0:if(o=t.nodes[e],i=r.components.find(function(t){return t.name===o.title})){u.next=4;break}throw"Component "+o.title+" was not found";case 4:return u.next=6,regeneratorRuntime.awrap(Z.fromJSON(i,o));case 6:n[e]=u.sent,r.addNode(n[e]);case 8:case"end":return u.stop()}},null,r)})));case 13:Object.keys(t.nodes).forEach(function(e){var o=t.nodes[e],i=n[e];o.outputs.forEach(function(t,e){t.connections.forEach(function(t){var o=t.node,u=t.input,a=n[o].inputs[u];r.connect(i.outputs[e],a)})})}),"object"===T(t.groups)&&Object.keys(t.groups).forEach(function(e){var o=W.fromJSON(t.groups[e]);t.groups[e].nodes.forEach(function(t){var e=n[t];o.addNode(e)}),r.addGroup(o)}),o.next=22;break;case 17:return o.prev=17,o.t0=o.catch(10),console.warn(o.t0),this.eventListener.trigger("error",o.t0),o.abrupt("return",!1);case 22:return this.view.update(),this.eventListener.persistent=!0,o.abrupt("return",!0);case 25:case"end":return o.stop()}},null,this,[[10,17]])}}]),t}(),st=function(){function t(e,n){var r=this;G(this,t),this.inputs=e,this.action=n,this.next=[],this.outputData=null,this.closed=[],this.getOptions().forEach(function(t){t.forEach(function(t){t.task.next.push({index:t.index,task:r})})})}return A(t,[{key:"getOptions",value:function(){return this.inputs.filter(function(t){return t[0]&&t[0].task})}},{key:"getOutputs",value:function(){return this.inputs.filter(function(t){return t[0]&&t[0].get})}},{key:"reset",value:function(){this.outputData=null}},{key:"run",value:function(t){var e=this,n=this.getOutputs().map(function(t){return t.map(function(t){if(t)return t.run(),t.get()})});this.outputData||(this.outputData=this.action(n,t),this.next.filter(function(t){return!e.closed.includes(t.index)}).forEach(function(t){return t.task.run()}))}},{key:"option",value:function(t){return{task:this,index:t}}},{key:"output",value:function(t){var e=this;return{run:e.run.bind(e),get:function(){return e.outputData[t]}}}}]),t}();t.Component=H,t.ContextMenu=z,t.Control=I,t.Diff=Q,t.NodeEditor=at,t.Engine=et,t.Group=W,t.Input=D,t.Node=Z,t.Output=J,t.Socket=P,t.Task=st,t.Module=_,t.ModuleManager=S,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=d3-node-editor.min.js.map